version: '2.2'

services:
  # Web UI + API mode (current default)
  statuspanel:
    image: trydirect/status:unstable
    container_name: statuspanel
    ports:
     - "5001:5000"
    volumes:
     - .:/app
     # NOTE: Status Panel no longer mounts Docker socket when compose-agent is enabled
     # - /var/run/docker.sock:/var/run/docker.sock
    # - /data/encrypted:/data/encrypted
    env_file:
      - .env
    environment:
      - NGINX_CONTAINER=nginx
      - COMPOSE_AGENT_ENABLED=true
    # Default: serve with UI
    command: ["serve", "--port", "5000", "--with-ui"]

  # Daemon mode with long polling (uncomment to use)
  agent:
    image: trydirect/status:unstable
    container_name: statuspanel_agent
    volumes:
     # Agent needs Docker socket for container monitoring and logs
     - /var/run/docker.sock:/var/run/docker.sock
     # Mount docker CLI from host for deploy_app/remove_app commands
     - /usr/bin/docker:/usr/bin/docker:ro
     - /usr/libexec/docker/cli-plugins:/usr/libexec/docker/cli-plugins:ro
    env_file:
      - .env
    environment:
      - DASHBOARD_URL=https://stacker.try.direct
      - DEPLOYMENT_HASH=$DEPLOYMENT_HASH # from .env , deployment identifier
      - POLL_TIMEOUT_SECS=30
      - POLL_BACKOFF_SECS=5
      - POLL_MAX_BACKOFF_SECS=60
      - COMPOSE_AGENT_ENABLED=false
    # No subcommand = daemon mode with polling
    command: []

  # Compose Agent Sidecar (Docker Compose operations + MCP Gateway)
  compose-agent:
    image: trydirect/status:compose-agent-unstable
    container_name: compose-agent
    volumes:
     # Compose agent has exclusive Docker socket access for operations
     - /var/run/docker.sock:/var/run/docker.sock
     # Mount docker CLI from host for compose commands
     - /usr/bin/docker:/usr/bin/docker:ro
     - /usr/libexec/docker/cli-plugins:/usr/libexec/docker/cli-plugins:ro
     - .:/app
    env_file:
      - .env
    environment:
      - DASHBOARD_URL=https://stacker.try.direct
      - DEPLOYMENT_HASH=$DEPLOYMENT_HASH
      - POLL_TIMEOUT_SECS=30
      - POLL_BACKOFF_SECS=5
      - POLL_MAX_BACKOFF_SECS=60
      - CONTROL_PLANE=compose_agent
      - VAULT_TOKEN_KEY=compose_agent_token
    restart: on-failure
    # Compose mode daemon with compose-specific config
    command: ["--config", "/app/config.json", "--compose-mode"]